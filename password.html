<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YR Jerseys - Admin System</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); width: 100%; max-width: 650px; text-align: center; }
        .logo { max-width: 80px; margin-bottom: 10px; }
        h1 { font-size: 20px; color: #222; }
        input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #e1e1e1; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        button { width: 100%; padding: 12px; background-color: #000; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; margin-top: 10px; transition: 0.2s; }
        button:hover { background-color: #333; }
        .btn-save { background-color: #27ae60; padding: 5px; font-size: 12px; margin: 0; }
        .btn-delete { background-color: #e74c3c; padding: 5px; font-size: 12px; margin: 0; }
        .secondary { background-color: #eee; color: #333; }
        .hidden { display: none !important; }
        .error { color: #e74c3c; font-size: 13px; display: none; margin: 5px 0; }
        .success { color: #27ae60; font-size: 14px; margin-top: 10px; }
        
        .admin-scroll { max-height: 350px; overflow-y: auto; margin-top: 15px; border: 1px solid #eee; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; }
        th { background: #f8f9fa; }
        
        .register-footer { margin-top: 20px; font-size: 14px; color: #666; }
        .register-link { color: #007bff; text-decoration: none; font-weight: bold; cursor: pointer; opacity: 0.5; transition: 0.3s; }
        .register-link.enabled { opacity: 1; text-decoration: underline; }
    </style>
</head>
<body>

<div class="card">
    <img src="https://i.postimg.cc/brSRNJm1/7D29AA03-1C4F-4578-85D5-F3A23D3D84EC.png" alt="YR Logo" class="logo">
    <h1>YR Jerseys</h1>

    <div id="step-1">
        <input type="text" id="input-username" placeholder="הזן שם משתמש">
        <p id="user-not-found" class="error">משתמש לא נמצא</p>
        <button onclick="checkUserStep1()">המשך</button>
    </div>

    <div id="step-user" class="hidden">
        <p>שלום, <b id="display-heb-name" style="color: #007bff;"></b></p>
        <label>הסיסמה שלך:</label>
        <input type="text" id="edit-own-password">
        <button onclick="saveOwnPassword()">שמור סיסמה</button>
        <button class="secondary" onclick="resetUI()">התנתק</button>
        <p id="user-save-success" class="success hidden">נשמר בהצלחה!</p>
    </div>

    <div id="step-admin-auth" class="hidden">
        <p>שלום <b id="admin-display-name" style="color: #007bff;"></b>, הזן סיסמה:</p>
        <input type="password" id="admin-login-pass" placeholder="סיסמה">
        <button onclick="verifyAdmin()">כניסה לניהול</button>
        <button class="secondary" onclick="resetUI()">ביטול</button>
    </div>

    <div id="admin-dashboard" class="hidden">
        <h3 id="panel-title">ניהול משתמשים</h3>
        <div id="add-user-area" style="background: #f9f9f9; padding: 10px; border-radius: 10px; border: 1px solid #ddd;">
            <p style="margin:0 0 5px 0"><b>הוספת משתמש חדש</b></p>
            <input type="text" id="new-heb" placeholder="שם מלא">
            <input type="text" id="new-uid" placeholder="שם משתמש (ID)">
            <input type="text" id="new-pass" placeholder="סיסמה">
            <button class="btn-save" onclick="addUser()">בצע רישום</button>
        </div>
        <div id="admin-only-table" class="admin-scroll">
            <table>
                <thead>
                    <tr>
                        <th>שם משתמש</th>
                        <th>שם מלא</th>
                        <th>סיסמה</th>
                        <th>אדמין</th>
                        <th>רישום</th>
                        <th>פעולה</th>
                    </tr>
                </thead>
                <tbody id="admin-table-body"></tbody>
            </table>
        </div>
        <button class="secondary" onclick="resetUI()" style="margin-top:15px">התנתק</button>
    </div>
</div>

<div id="footer-area" class="register-footer">
    <span id="reg-link-btn" class="register-link" onclick="handleRegClick()">רישום משתמש חדש</span>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDLHENaXTeorjL87sExB1EJrH7mrEnNYOA",
        authDomain: "timetable-titus.firebaseapp.com",
        projectId: "timetable-titus",
        storageBucket: "timetable-titus.appspot.com",
        messagingSenderId: "199146911555",
        appId: "1:199146911555:web:5d9436d716dfc6de7361f6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let userData = null;

    window.showSection = (id) => {
        ['step-1', 'step-user', 'step-admin-auth', 'admin-dashboard'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    };

    window.checkUserStep1 = async function() {
        const uid = document.getElementById('input-username').value.trim();
        if (!uid) return;
        
        const docSnap = await getDoc(doc(db, "users", uid));
        const regBtn = document.getElementById('reg-link-btn');

        if (docSnap.exists()) {
            userData = docSnap.data();
            document.getElementById('user-not-found').style.display = 'none';

            if (userData.isAdmin) {
                document.getElementById('footer-area').classList.add('hidden'); 
                document.getElementById('admin-display-name').innerText = userData.hebrewName || userData.username;
                showSection('step-admin-auth');
            } else {
                document.getElementById('display-heb-name').innerText = userData.hebrewName || userData.username;
                document.getElementById('edit-own-password').value = userData.password || "";
                showSection('step-user');
                
                if (userData.canRegister) {
                    regBtn.classList.add('enabled');
                } else {
                    regBtn.classList.remove('enabled');
                }
            }
        } else {
            document.getElementById('user-not-found').style.display = 'block';
            userData = null;
            regBtn.classList.remove('enabled');
        }
    };

    window.verifyAdmin = function() {
        if (document.getElementById('admin-login-pass').value === userData.password) {
            loadAdminDashboard();
        } else {
            alert("סיסמה שגויה");
        }
    };

    async function loadAdminDashboard() {
        showSection('admin-dashboard');
        document.getElementById('admin-only-table').classList.remove('hidden');
        const querySnapshot = await getDocs(collection(db, "users"));
        const tbody = document.getElementById('admin-table-body');
        tbody.innerHTML = "";

        querySnapshot.forEach(docSnap => {
            const u = docSnap.data();
            const tr = document.createElement('tr');
            const regDisabled = u.isAdmin ? 'disabled' : '';
            
            tr.innerHTML = `
                <td><input type="text" value="${u.username}" id="edit-id-${u.username}" style="width:50px"></td>
                <td><input type="text" value="${u.hebrewName}" id="edit-heb-${u.username}" style="width:60px"></td>
                <td><input type="text" value="${u.password}" id="edit-pass-${u.username}" style="width:50px"></td>
                <td><input type="checkbox" ${u.isAdmin ? 'checked' : ''} id="edit-admin-${u.username}" onchange="toggleRegCheckbox('${u.username}')"></td>
                <td><input type="checkbox" ${u.canRegister ? 'checked' : ''} id="edit-reg-${u.username}" ${regDisabled}></td>
                <td>
                    <button class="btn-save" onclick="saveUserChanges('${u.username}')">שמור</button>
                    <button class="btn-delete" onclick="deleteUser('${u.username}')">X</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    window.toggleRegCheckbox = function(uid) {
        const isAdmin = document.getElementById(`edit-admin-${uid}`).checked;
        const regBox = document.getElementById(`edit-reg-${uid}`);
        if (isAdmin) {
            regBox.checked = false;
            regBox.disabled = true;
        } else {
            regBox.disabled = false;
        }
    };

    window.saveUserChanges = async function(oldUid) {
        const newUid = document.getElementById(`edit-id-${oldUid}`).value.trim();
        const isAdmin = document.getElementById(`edit-admin-${oldUid}`).checked;
        if (newUid !== oldUid) await deleteDoc(doc(db, "users", oldUid));
        await setDoc(doc(db, "users", newUid), {
            username: newUid,
            hebrewName: document.getElementById(`edit-heb-${oldUid}`).value,
            password: document.getElementById(`edit-pass-${oldUid}`).value,
            isAdmin: isAdmin,
            canRegister: isAdmin ? false : document.getElementById(`edit-reg-${oldUid}`).checked
        });
        alert("נשמר");
        loadAdminDashboard();
    };

    window.addUser = async function() {
        const u = document.getElementById('new-uid').value.trim();
        const h = document.getElementById('new-heb').value;
        if(!u || !h) return alert("מלא שדות");
        await setDoc(doc(db, "users", u), { username: u, hebrewName: h, password: document.getElementById('new-pass').value, isAdmin: false, canRegister: false });
        alert("משתמש נוסף");
        if(userData && userData.isAdmin) loadAdminDashboard();
    };

    window.handleRegClick = function() {
        if (!userData) {
            alert("יש להזין קודם שם משתמש");
            return;
        }
        if (userData.canRegister) {
            showSection('admin-dashboard');
            document.getElementById('admin-only-table').classList.add('hidden');
            document.getElementById('panel-title').innerText = "רישום משתמש חדש";
        } else {
            alert("אין לך הרשאה להוסיף משתמשים");
        }
    };

    window.saveOwnPassword = async function() {
        await setDoc(doc(db, "users", userData.username), { password: document.getElementById('edit-own-password').value }, { merge: true });
        document.getElementById('user-save-success').classList.remove('hidden');
        setTimeout(() => document.getElementById('user-save-success').classList.add('hidden'), 2000);
    };

    window.deleteUser = async function(uid) {
        if(uid === 'Amit') return alert("מנהל על!");
        if(confirm(`למחוק את ${uid}?`)) {
            await deleteDoc(doc(db, "users", uid));
            loadAdminDashboard();
        }
    };

    window.resetUI = () => {
        userData = null;
        document.getElementById('footer-area').classList.remove('hidden');
        document.getElementById('reg-link-btn').classList.remove('enabled');
        document.getElementById('input-username').value = "";
        document.getElementById('admin-login-pass').value = "";
        document.getElementById('panel-title').innerText = "ניהול משתמשים";
        showSection('step-1');
    };
</script>
</body>
</html>
